# .github/workflows/databricks-trigger.yml
name: Trigger Databricks Job on Push

on:
  push:
    branches: ["**"]

jobs:
  trigger-databricks:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Databricks Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_JOB_ID: ${{ secrets.DATABRICKS_JOB_ID }}
        run: |
          set -euo pipefail

          # Safely escape the commit message (handles newlines, quotes, etc.)
          COMMIT_MESSAGE=$(jq -R -s <<< "${{ github.event.head_commit.message }}")

          curl -X POST "${DATABRICKS_HOST%/}/api/2.1/jobs/run-now" \
            -H "Authorization: Bearer $DATABRICKS_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "job_id": $DATABRICKS_JOB_ID,
            "notebook_params": {
              "repo": "${{ github.repository }}",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "commit_author_name": "${{ github.event.head_commit.author.name }}",
              "commit_author_email": "${{ github.event.head_commit.author.email }}",
              "commit_message": $COMMIT_MESSAGE,
              "commit_url": "${{ github.event.head_commit.url }}",
              "github_actor": "${{ github.actor }}",
              "github_run_id": "${{ github.run_id }}"
            },
            "run_name": "Push by ${{ github.actor }} â€¢ ${{ github.sha }}",
            "idempotency_key": "${{ github.run_id }}-${{ github.run_attempt }}"
          }
          EOF

          echo "Databricks job triggered successfully!"